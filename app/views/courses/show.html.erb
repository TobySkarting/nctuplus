<%= javascript_include_tag "courses/content", "data-turbolinks-track" => true %>
<%= javascript_include_tag "courses/chart", "data-turbolinks-track" => true %>
<%= javascript_include_tag "courses/past_exam", "data-turbolinks-track" => true %>
<%= stylesheet_link_tag "courses-show" %>

<div class="row">
	<div class="blue-menu" style="postion:absolute;left:0px;margin:0px;">
		<%= render "/course_content/scroll_sidebar"%>
	</div>
	
	<div class="container-fluid scroll-content col-md-offset-2" id="first-row">
		<div class="row" id="tc" >
			<div class="col-md-10">
				<h1 class="scroll-title" data-offset="100">	
					<%= @data[:course_name] %>－<%=@data[:course_teachers]%>
                                </h1>
                                  <small style="font-size: 37%" title="E3課程資料同步時間">
						最後同步時間 <%=@data[:updated_at].strftime("%F %R")%>
					</small>
			</div>
			<div class="col-md-2" id="teacher-name">
				<br>
				<span class="pull-right">
					<span style="display:inline-block">
						<div class="share-course"></div>
					</span>
				</span>
			</div>
		</div>
		
		<div class="separation-line"></div>
		
		<div class="row " id="single-compare" >
		</div>
		<br><br>
		<div class="separation-line"></div>
		<br><br>	
                        <div class="panel-heading course-info">
			<h4 style="padding-left:15px;">
				<p><h3><i class="fa fa-book"></i><strong> 課程資訊</strong></h3><br></p>
					<table class="table-invisible" >
						<tr>
							<td>永久課號 <strong><%=@data[:course_real_id]%></strong></td>
							<td>學分 <strong><%=@data[:course_credit]%></strong></td>
						</tr>
						<tr>
							<td>
							<%=link_to "課程綱要","https://course.nctu.edu.tw/Course/CrsOutline/show.asp?Acy=#{@data[:year]}&Sem=#{@data[:half]}&CrsNo=#{@data[:temp_cos_id]}",target: "_blank"%>
							
							<% if not @data[:open_on_latest]%>
								(本學期無開課)
							<% end %>
							</td>
							<td>
							查看更多 
							<%=link_to("javascript:void(0);", :class=>"see-more-course") do%>	
								<%=fa_icon "search-plus"%>
							<% end %>
							</td>
						</tr>
					</table>
                        </h4>

				<%=render "/course_content/course_info" %>
                        </div>

			<div class="separation-line"></div>
			<div id="course-recommend" class="panel-heading" >
			<h4 style="padding-left:15px;">
                          <p><h3><%=fa_icon "cube"%></i><strong> 修了這堂課的人，也修了...</strong></h3><br></p>
                                <% if not @data[:recommend_courses]%>
                                  找不到OAO
                                <% else %>
                                  <% @data[:recommend_courses].each do |c| %>
                                    <a href="/courses/<%=c["id"]%>"><%= c["name"] %></a>&emsp;
                                  <% end %>
                                <% end %>
                        </div>


			<div class="separation-line"></div>
			<div id="course-tips" class="panel-heading" >
				<h2 class="panel-title">
					<p><h3><strong><%=fa_icon "gamepad"%> 課程攻略</strong></h3></p>
				</h2>	
			</div>
			<div class="panel-body" >
				<div class="row" >
					<%=fa_icon "cube"%> 作業/考試：
					<%=link_to "編輯", "javascript:void(0);", :class=>"edit-head"%>	
					</br></br>
					<div id="course_content_head">
						<%=loading_img%>
					</div>
				</div>
				<hr>
				<div class="row">
					<%=fa_icon "cube"%> 其他內容：
					<%=link_to "編輯", "javascript:void(0);", :class=>"edit-lists"%>	
					</br></br>
					<div id="course_content_lists">
						<%=loading_img%>
					</div>
				</div>
					
			</div>
			<div class="separation-line"></div>
			
			<div class="panel-heading" id="statistics">
				<h2 class="panel-title">
					<p id="statistics-header">
						<h3><%=fa_icon "align-left"%><strong>  歷年統計</strong></h3>
					</p>	
				</h2>	
			</div>
			<div id="container-reg-num" style="height:80%; width:80%;"></div></br>
			<div id="container-score" style="height:80%; width:80%;"></div>
			<div class="row" style="position:relative;">
				<div class="avg_score" id = "avg_score1">
						<h1><strong></strong></h1>
						
				</div>
				<div class="avg_score" id = "avg_score2">
						
						同課程最高成績
				</div>
				<div class="avg_score" id = "teacher_name">
						<h2><strong>粼粼林</strong></h2>
						同課程最高分老師
				</div>
			</div>
			<br><br>
			<div class="separation-line"></div>
			
			
			<div id="course-tips" class="panel-heading">
				<h2 class="panel-title">
					<p>
						<h3><strong><%=fa_icon "weixin"%> 留言板：</strong></h3>
					</p>
				</h2>	
			</div>
			
			<div class="well bg-grey " id="comments"></div>
		<% if current_user %>	
			<div class="row comment-form" >
				
				<div class="col-sm-2 col-sm-offset-1">
					<%=select_tag "comment_type",options_for_select([["推",1],["→",2],["噓",3]],"推"), :class=>"form-control"%>
				</div>
				<div class="col-sm-6">
					<%=text_field_tag "comment_content", "", :class=>"form-control", :maxlength=>"32" %>
				</div>
				<div class="col-sm-1">
					<%=button_tag "確定", :class=>"form-control btn btn-success comment-submit"%>
				</div>
			</div>
		<% end %>	
		<div class="separation-line"></div>
		
			<div class="row">
				<div id="compare" class="panel-body">
				</div>
				<div id="discuss" class="panel-body">
				</div>
				<div id="files" class="panel-body">
				</div>		
			</div>
		
	</div>
	
</div>




<%=render "/course_content/xtmpl/xtmpl_content_head"%>
<%=render "/course_content/xtmpl/xtmpl_content_lists" %>
<%=render "/course_content/xtmpl/xtmpl_course_comment_lists"%>
<script>
	$(document).ready(function(){
		var cd_id = window.location.pathname.split("/")[2];
		// course-info toggle		
		$('.old-course').hide();
		$('.see-more-course').click(function(){
			$('.old-course').toggle();
			$(this).find('.fa').toggleClass("fa-search-minus");
		});	
			

    var _getAverage = function(data){
      var teacherScore = [0, 0] ;
      for(var j=0, tmp; tmp=data["data"][j]; ++j){
        if(tmp["y"]==0)
          continue;
        teacherScore[0] += tmp["y"] ;
        teacherScore[1]++ ;
      }
      return teacherScore[1]==0 ? 0 : ((teacherScore[0]*1.0)/teacherScore[1]).toFixed(2) ;
    };
    
  // get the top avg score and teacher from related courses 
    var getTopScore = function(data){     
      var avgScores = [] ;
      for(var i=0, tmp; tmp=data[i]; ++i){
        var teacherScore = _getAverage(tmp);
        avgScores.push({avg: teacherScore, teacher: tmp["name"]});
      }
      if(avgScores.length==0)
        return {avg: "N/A", teacher: "N/A"} ;
      else  
        return _.max(avgScores, function(ele){ return ele.avg; });
    }
  // get the avg score of current course  
    var getSpecifiedAvgScore = function(data, teacher_name){      
      for(var i=0, tmp1; tmp1=data[i]; ++i){
        if(tmp1["name"]==teacher_name){         
           return _getAverage(tmp1);                    
        }
      }
      // only i==0 will go here
      return "N/A" ;
    };
    
		$.getJSON("/course_content/get_course_info.json?cd_id=<%=@data[:course_detail_id]%>", function (json_data) {		
			var avg1 = getTopScore(json_data["chart"]["score_data"]);
		  var avg2 = (getSpecifiedAvgScore(json_data["chart"]["score_data"], json_data["teacher_name"]));
			
			$("#avg_score1").html("<h1><strong>"+avg2+"</strong></h1>"+"本課程平均成績");
			$("#avg_score2").html("<h1><strong>"+avg1.avg+"</strong></h1>"+"同類課程最高成績");
			$("#teacher_name").html("<h1><strong>"+avg1.teacher+"</strong></h1>"+"同類課程最高分老師");
			 
      var data = json_data.chart ;
		  show_chart_reg(data);
			show_chart_score(data);
			if(!(data.show_reg || data.show_score))
				$('#statistics-header').append(' 無資料');
		
		  data = json_data.head ;
		  $("#course_content_head").html(tmpl("content-head", data));
			head_binding(<%=j (user_signed_in?) ? "true" : "false"%>, cd_id);	
		
		  data = json_data.list; 
		  $('#course_content_lists').html(tmpl("content-lists", data));
			lists_binding(<%=j (user_signed_in?) ? "true" : "false"%>, cd_id);			
		
		  data = json_data.comment ;
		  $('#comments').html(tmpl("course-comments", data));
			comment_binding(cd_id);
		});
	
		//teacher compare & rank
		$("#single-compare").load("/course_content/single_compare?ct_id=<%=j @data[:course_teachership_id]%>", function() {
			$('body').scrollspy('refresh');
			$("#discuss").load("/discusses/list_by_ct?ct_id=<%=@data[:course_teachership_id]%>&target=<%=params[:target]%>", function() {
				$('body').scrollspy('refresh');
				$("#files").load("/past_exams/course_page?ct_id=<%=@data[:course_teachership_id]%>", function() {
					$('body').scrollspy('refresh');
					$('body').scrollTo("#course-name",10,{offset:-80});
					<% if params[:first_show]=="discussion" %>
						$('body').scrollTo("#discuss",700,{offset:-60});
					<% elsif params[:first_show]=="files" %>
						$('body').scrollTo("#files",700,{offset:-60});
					<% end %>
				});
			});
		});

		// FB share	
		<% share_url="#{root_url}courses/#{@data[:course_detail_id]}" %>
		var share_url='<%=j share_url.html_safe %>';
		var course_title="<%= @data[:course_name] %> <%=@data[:course_teachers]%>";
		new Share(".share-course",{
			ui: {
				flyout: "bottom center",
				button_text :"分享",
				button_font : false,
				//icon_font : false
			},
			networks: {
				facebook: {
					app_id: "<%=Facebook::APP_ID%>",
					title : course_title,
					caption: "NCTU+ 交大智慧選課系統",
					description: "",
					url :share_url,
				},
				google_plus:{
					url :share_url
				},
				twitter:{
					url :share_url,
					description :course_title
				},
				pinterest:{
					enabled:false
				},
				email:{
					enabled:false
				}
			},
		});

	});
	
</script>
